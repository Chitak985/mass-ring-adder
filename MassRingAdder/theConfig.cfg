@Kopernicus:FINAL                                         // Initial allowRing and settings accessibility 
{
	@Body[*]                                                // Apply to every single Body
	{
		allowRing = true                                      // Allow adding a ring by default
		configWasHere = false                                 // Variable to know if a config was applied
		ignoreWithRings = #$/@MassRingAdderSettings/ignoreWithRings$
		ignoreIncompatible = #$/@MassRingAdderSettings/ignoreIncompatible$
		overrideOnAll = #$/@MassRingAdderSettings/overrideOnAll$
		overrideOffAll = #$/@MassRingAdderSettings/overrideOffAll$
		proceduralRings = #$/@MassRingAdderSettings/proceduralRings$
	}
}
@Kopernicus:FINAL                                         // All bodies that are not incompatible will be marked compatible
{
	@Body[*]:HAS[!#MRAincompatible[?rue]]
	{
		&MRAincompatible = false                              // Add MRAincompatible if it does not exist
	}
}
@Kopernicus:FINAL                                         // Do not add rings if rings are present (unless overriden)
{
	@Body[*]:HAS[@Rings,*&#ignoreWithRings[?rue]]
	{
		@allowRing = false                                    // Do not add a ring
	}
}
@Kopernicus:FINAL                                         // Do not add rings if incompatible (unless overriden)
{
	@Body[*]:HAS[#MRAincompatible[?rue]&#ignoreIncompatible[?rue]]
	{
		@allowRing = false                                    // Do not add a ring
	}
}
@Kopernicus:FINAL                                         // Override: all on (must be compatible)
{
	@Body[*]:HAS[#overrideOnAll[?rue]&#MRAincompatible[?alse]&#ignoreIncompatible[?rue]]
	{
		@allowRing = true                                     // Do add a ring
	}
}
@Kopernicus:FINAL                                         // Override: all on (overriden to allow anything)
{
	@Body[*]:HAS[#overrideOnAll[?rue]&&#ignoreIncompatible[?alse]]
	{
		@allowRing = true                                     // Do add a ring
	}
}
@Kopernicus:FINAL                                         // Override: all off (overrides everything, other overrides do not matter)
{
	@Body[*]:HAS[#overrideOffAll[?rue]]
	{
		@allowRing = false                                    // Do not add a ring
	}
}

@Kopernicus:FINAL                                         // Config rings
{
	@Body[*]:HAS[@RINGBODY,*&#allowRing[true]]              // Add rings if a configuration is present and ring is allowed
	{
		@configWasHere = true                                 // Mark Body as already processed by a config - no procedural ring needed
		@RINGBODY,0                                           // Ignore all RINGBODY other than the first
		{
			|_ = RINGBODYREAL                                   // Rename to avoid deletion
		}
		!RINGBODY,* {}                                        // Delete useless RINGBODY
		%Rings                                                // Add new rings or add them to an existing set
		{
			Ring                                                // Add the Ring using data from the configuration
			{
				innerRadius = #$../../RINGBODYREAL/innerRadius$   // Load innerRadius
        outerRadius = #$../../RINGBODYREAL/outerRadius$   // Load outerRadius

        InnerRadiusMultiplier                             // Default value from wiki
		    {
			    	key = 0 1 0 0                                 // Default value from wiki
		    }
		    OuterRadiusMultiplier                             // Default value from wiki
		    {
			    	key = 0 1 0 0                                 // Default value from wiki
		    }
        
		    thickness = #$../../RINGBODYREAL/thickness$       // Load thickness
		    steps = 120                                       // Default value from wiki

        texture = MassRingAdder/MainRing.dds              // Use default custom ring texture
        tiles = 10                                        // Default value from wiki
        color = #$../../RINGBODYREAL/color$               // Load color
        unlit = false                                     // Default value from wiki
		    useNewShader = false                              // Default value from wiki
		    penumbraMultiplier = 200                          // Default value from wiki

        angle = #$../../RINGBODYREAL/inclination$         // Load ring angle
        lockRotation = false                              // Default value from wiki
        rotationPeriod = 100                              // Default value that I chose for no reason
			}
		}
	}
}

@Kopernicus:FINAL                                         // Procedural rings
{                                                         // Creates a procedural ring if all conditions are met
	@Body[*]:HAS[#configWasHere[false]&#proceduralRings[?rue]&#allowRing[true]]
	{
		@Orbit                                                // Orbit holds the *ColorExists variables
		{
			iconColorExists = false                             // Buffer for icon color existence
			orbitColorExists = false                            // Buffer for orbit color existence
		}
		@Orbit:HAS[#nodeColor[*]]                             // Does orbit icon color exist?
		{
			iconColorExists = true                              // Set icon color existence buffer to true
		}
		@Orbit:HAS[#color[*]]                                 // Does orbit color exist?
		{
			orbitColorExists = true                             // Set orbit color existence buffer to true
		}
		%Rings                                                // Add new rings or add them to an existing set
		{
			Ring                                                // Add a procedural ring
			{
				name = TemporaryName                              // Temporary name for patches after
				innerRadius = 2000                                // Value I picked for no reason
        outerRadius = 5000                                // Value I picked for no reason

        InnerRadiusMultiplier                             // Default value from wiki
		    {
			    	key = 0 1 0 0                                 // Default value from wiki
		    }
		    OuterRadiusMultiplier                             // Default value from wiki
		    {
			    	key = 0 1 0 0                                 // Default value from wiki
		    }
        
		    thickness = 100                                   // Default value from wiki
		    steps = 120                                       // Default value from wiki

        texture = MassRingAdder/MainRing1.dds             // Use ring texture for procedural rings
        tiles = 10                                        // Default value from wiki
        color = 0.9, 0.9, 0.9, 0.9                        // Default is white, but will be replaced next
        unlit = false                                     // Default value from wiki
		    useNewShader = false                              // Default value from wiki
		    penumbraMultiplier = 200                          // Default value from wiki

        angle = 10                                        // Would be changed later in a patch sometime
        lockRotation = false                              // Default value from wiki
        rotationPeriod = 100                              // Default value that I chose for no reason
			}
			@Ring[TemporaryName]                                // Access the created ring to add buffer buffers
			{
				iconColorExists = #$../Orbit/iconColorExists$     // Transfer the icon color existence buffer from Orbit to here
				orbitColorExists = #$../Orbit/orbitColorExists$   // Transfer the orbit color existence buffer from Orbit to here
			}
			@Orbit                                              // Access Orbit to delete already moved buffers
			{
				!iconColorExists = DELETE                         // Delete buffer for icon color existence
				!orbitColorExists = DELETE                        // Delete buffer for orbit color existence
			}
			@Ring[TemporaryName]:HAS[#iconColorExists[true]]
			{
				@color = #$../../Orbit/nodeColor$                 // Apply the orbit icon color to ring color
			}
			@Ring[TemporaryName]:HAS[#orbitColorExists[true]&#iconColorExists[false]]
			{
				@color = #$../../Orbit/color$                     // Apply the orbit color to ring color if icon color hasn't been applied
			}
			@Ring[TemporaryName]                                // Clean up the created ring
			{
				!!iconColorExists = DELETE                        // Delete the moved buffer for icon color existence
				!orbitColorExists = DELETE                        // Delete the moved buffer for orbit color existence
				!name = DELETE                                    // Delete the no longer needed name
			}
		}
	}
}

@Kopernicus:FINAL                                         // Clean up
{
	@Body[*]                                                // Apply to every single Body
	{
		!allowRing = DELETE                                   // Delete all values created in the first patch
		!configWasHere = DELETE
		!ignoreWithRings = DELETE
		!ignoreIncompatible = DELETE
		!overrideOnAll = DELETE
		!overrideOffAll = DELETE
		!proceduralRings = DELETE
	}
}
